<script>(function(){
  if(!window.WPRestConnections){
    window.WPRestConnections = {};
  }
  var joinPath = function(){
    var parts = Array.prototype.slice.call( arguments );
    var path =  parts.reduce(function( array, part ){
      if(part){
        array.push(part.replace(/^\//,''))
      }return array;
    }, []).join('/')
    
    return /^http/.test(path) ? path : '/' + path;
  }
  var namedConfig = {};
  /**
  * Wordpress Rest API Connection Behavior
  *
  * @polymerBehavior
  */
 
  window.WPRestConnectionBehavior = {
    properties: {
      /**
      * Name of the connection.
      */
      name: {
        type: String,
        notify: true,
        value: 'default',
        observer: '__nameChanged'
      },
      /**
      * Host to connect to.
      */
      host: { 
        type: String, 
        notify: true
      },
      /**
      * Wordpress API namespace
      */
      namespace: { 
        type: String, 
        notify: true
      },
      /**
      * Wordpress API authentication key.
      */
      authKey: { 
        type: String, 
        notify: true
      },
      /**
      * Wordpress API authentication secret.
      */
      authSecret: { 
        type: String, 
        notify: true
      },
      /**
      * Last response results.
      */
      lastResponse: {
        type: Object,
        notify: true
      },
      /**
      * Last error.
      */
      lastError: {
        type: Object,
        notify: true
      },
      /**
      * Last discovery results.
      */
      lastDiscovery: {
        type: Object,
        notify: true
      }
    },
   __getUrl: function( path ){
     return joinPath( this.host, this.namespace, path );
   },
   __getHeaders: function(){
     var headers = {  'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/json' };
     headers['Authorization'] = 'Basic ' + window.btoa( this.authKey + ":" + this.authSecret );
     return headers;
   },
    __nameChanged: function( name ){
      window.WPRestConnections[name] = this;
    },
    __handleSuccess: function( response ){
      
      this.set('lastResponse', response );
      return response;
    },
    __handleDiscovery: function( response ){
      // console.log('rest behavior __handleDiscovery', response )
      this.set('lastDiscovery', response );
      return response;
    },
    __handleFailure: function( error ){
      // console.log('rest behavior __handleFailure', error )
      this.set('lastError', error )
      return error;
    },
    __sendRequest: function( method,path, data, params ){
      // console.log('send request')
      var xhr = document.createElement('iron-request');
      
      var url = this.__getUrl( path );
      var headers = this.__getHeaders();
      var body = data ? JSON.stringify(data) : null;
      method = method.toUpperCase();
      var request = xhr.send({
        url: url,
        method: method,
        handleAs: 'json',
        body: body,
        headers: headers
      });
      
      var promise = function( resolve, reject ){
        var success = function( xhr ){
          var response = xhr.response;
          // console.log('resolve request', response )
          resolve( response );
          
        };
        var failure = function( error ){
          error = xhr.response || error;
          // console.log('reject request', error)
          reject( error );
        };
        request.then( success.bind(this), failure.bind(this) );
      }.bind(this);
      return new Promise( promise );
    },
    __request: function( method,path, data, params ){
      // console.log('api request')
      return this.__sendRequest( method, path, data, params ).then( this.__handleSuccess.bind(this) , this.__handleFailure.bind(this))
    },
    __discover: function( path ){
      return this.__sendRequest( 'options', path||'' ).then( this.__handleDiscovery.bind(this), this.__handleFailure.bind(this) );
    },
    attached: function(){
      if(!this.name){
        this.name = 'default';
        
      }
    }
  };
})();
</script>
